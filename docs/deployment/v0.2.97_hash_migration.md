# Deployment Guide: v0.2.97 - User Profile Hash Migration

## Overview

Version 0.2.97 introduces hash-based public profile URLs, replacing user ID-based URLs. This requires a three-step database migration.

## What's Changing

**Before (v0.2.96 and earlier):**
- Public profile URLs: `/u/<user-id>/` (numeric ID)
- Example: `/u/123/`

**After (v0.2.97):**
- Public profile URLs: `/u/<hash>/` (10-character nanoID)
- Example: `/u/x9k2mP4aB1/`
- Optional nickname URLs: `/u/<nickname>/` (if user sets nickname)

## Migration Strategy

The migration is split into 3 safe steps:

1. **0034_add_user_profile_hash_field.py**
   - Adds `hash` field to UserProfile table
   - Field is NOT unique yet (allows population)
   - **Downtime**: None (non-breaking change)

2. **0035_populate_user_profile_hashes.py**
   - Populates hash values for all existing users
   - Uses bulk updates (100 records per batch)
   - Generates unique 10-character nanoIDs
   - **Downtime**: Minimal (depends on user count)

3. **0036_add_hash_unique_constraint.py**
   - Adds unique constraint to hash field
   - **Downtime**: None (quick schema change)

## Performance Estimates

| User Count | Estimated Time | Notes |
|------------|---------------|-------|
| < 100 | < 1 second | Negligible |
| 100-1,000 | 1-3 seconds | Single batch |
| 1,000-10,000 | 3-10 seconds | Multiple batches |
| 10,000+ | 10-30 seconds | May need optimization |

## Pre-Deployment Checklist

- [ ] Backup production database
- [ ] Test migration on staging/QA environment
- [ ] Verify no active user sessions during deployment (optional)
- [ ] Check database has enough space (minimal - adds one 10-char field)
- [ ] Ensure `nanoid` package is installed in production environment

## Deployment Steps

### Standard Deployment (Recommended)

```bash
# 1. Pull latest code
git pull origin main

# 2. Install dependencies (if needed)
uv pip install -r requirements.txt

# 3. Run migrations
DJANGO_SETTINGS_MODULE=webapp.settings python manage.py migrate

# 4. Restart application server
# (varies by deployment method)
```

### High-Traffic Deployment (Optional)

For very high-traffic sites (1000+ concurrent users):

```bash
# 1. Enable maintenance mode (if available)

# 2. Pull latest code
git pull origin main

# 3. Run migrations during low-traffic period
DJANGO_SETTINGS_MODULE=webapp.settings python manage.py migrate

# 4. Restart application server

# 5. Disable maintenance mode
```

## Rollback Procedure

If migration fails or causes issues:

```bash
# Roll back to before hash migration
DJANGO_SETTINGS_MODULE=webapp.settings python manage.py migrate web 0033

# Restore from backup if needed
```

## Verification Steps

After deployment:

1. **Check Migration Status**
   ```bash
   DJANGO_SETTINGS_MODULE=webapp.settings python manage.py showmigrations web
   ```
   Should show:
   ```
   [X] 0034_add_user_profile_hash_field
   [X] 0035_populate_user_profile_hashes
   [X] 0036_add_hash_unique_constraint
   ```

2. **Verify Data**
   ```bash
   DJANGO_SETTINGS_MODULE=webapp.settings python manage.py shell
   ```
   ```python
   from web.models import UserProfile

   # Check all profiles have hashes
   empty_hashes = UserProfile.objects.filter(hash='').count()
   print(f"Profiles without hash: {empty_hashes}")  # Should be 0

   # Check hash uniqueness
   total = UserProfile.objects.count()
   unique_hashes = UserProfile.objects.values('hash').distinct().count()
   print(f"Total profiles: {total}, Unique hashes: {unique_hashes}")  # Should match

   # Sample some hashes
   for p in UserProfile.objects.all()[:5]:
       print(f"User {p.user.email}: {p.hash}")
   ```

3. **Test Public Profile Access**
   - Visit dashboard
   - Click "Public Profile" button
   - Verify URL format is `/u/<10-char-hash>/`
   - Verify profile loads correctly

4. **Test Nickname URLs (if users have nicknames)**
   - Set a nickname in account settings
   - Visit `/u/<nickname>/`
   - Verify it loads the same profile as hash URL

## Breaking Changes

⚠️ **Important**: Old URL format `/u/<user-id>/` will NO LONGER WORK

**Impact:**
- Existing bookmarks using user IDs will return 404
- Links shared before v0.2.97 will break
- External references to user profiles will need updating

**Mitigation:**
- Users can share new hash-based URLs
- Users can optionally set nicknames for pretty URLs
- Both hash and nickname URLs work simultaneously (if nickname is set)

## Troubleshooting

### Issue: Migration 0035 times out

**Cause**: Too many users for single operation

**Solution**: Increase batch size or timeout
```python
# In migration 0035, change batch_size:
batch_size = 500  # Increase from 100
```

### Issue: Duplicate hash errors

**Cause**: Extremely unlikely (nanoID collision)

**Solution**: Migration has built-in collision detection and retry logic. If this occurs:
1. Check logs for the problematic hash
2. Manually generate a new hash for affected user
3. Re-run migration

### Issue: User sees 404 on old bookmarked URL

**Expected behavior** - this is a breaking change.

**User action**:
- Click "Public Profile" from dashboard to get new URL
- Set a nickname for a custom URL

## Post-Deployment Tasks

- [ ] Update any documentation referencing old URL format
- [ ] Update any external systems that link to user profiles
- [ ] Monitor error logs for 404s on `/u/<numeric>/` patterns
- [ ] Consider adding redirect from old format (optional, not recommended)

## Security Considerations

### Why Hash Instead of User ID?

1. **Privacy**: User IDs are sequential and reveal registration order
2. **Security**: IDs can be enumerated to discover all users
3. **Non-guessable**: Hash-based URLs are harder to discover
4. **Future-proof**: Allows for custom URLs without exposing internals

### Hash Characteristics

- **Length**: 10 characters
- **Character set**: URL-safe base64 (A-Z, a-z, 0-9, -, _)
- **Collision probability**: ~1 in 64^10 (1,152,921,504,606,846,976)
- **Uniqueness**: Enforced by database unique constraint + generation logic

## Support

If you encounter issues during deployment:

1. Check application logs
2. Check database migration logs
3. Review this guide's troubleshooting section
4. Contact development team with:
   - Migration status output
   - Error messages
   - Number of affected users
   - Database size/type
