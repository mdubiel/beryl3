{% extends "base.html" %}
{% load i18n %}
{% load lucide %}
{% load widget_tweaks %}

{% block title %}{% if item %}Edit Item{% else %}Add Item to {{ collection.name }}{% endif %}{% endblock %}

{% block breadcrumbs %}
    <li><a href="{% url 'collection_list' %}">{% lucide 'layout-list' size=16 %} All Collections</a></li>
    <li><a href="{{ collection.get_absolute_url }}">{% lucide 'package' size=16 %} {{ collection.name|truncatechars:20 }}</a></li>
    <li>
        <span class="inline-flex gap-2 items-center">
            {% if item %}
                {% lucide 'pencil' size=16 %} Edit Item
            {% else %}
                {% lucide 'plus' size=16 %} Add New Item
            {% endif %}
        </span>
    </li>
{% endblock breadcrumbs %}


{% block content %}
<div class="flex justify-center">
    <form method="post" class="w-full">
        {% csrf_token %}
        <fieldset class="fieldset bg-base-200 border-base-300 rounded-box w-full max-w-2xl mx-auto border p-6">
            
            <legend class="fieldset-legend">
                {% if item %}Edit {{ item.name }}{% else %}Add New Item to "{{ collection.name }}"{% endif %}
            </legend>
            
{% if form.non_field_errors %}<div class="alert alert-error my-2"><span>{{ form.non_field_errors.as_text }}</span></div>{% endif %}

            <div class="form-control w-full mb-4">
                <label class="label" for="{{ form.name.id_for_label }}"><span class="label-text">{{ form.name.label }}</span></label>
                {% render_field form.name class="input input-bordered w-full" placeholder="e.g., Action Comics #1" %}
                {% if form.name.errors %}<div class="text-error text-sm mt-1">{{ form.name.errors.as_text }}</div>{% endif %}
            </div>

            {% if not item %}
            <div class="form-control w-full mb-4">
                <label class="label" for="{{ form.item_type.id_for_label }}"><span class="label-text">{{ form.item_type.label }}</span></label>
                {% render_field form.item_type class="select select-bordered w-full" hx-get="/items/get-type-attributes/" hx-target="#dynamic-attributes-container" hx-trigger="change" hx-swap="innerHTML" %}
                {% if form.item_type.errors %}<div class="text-error text-sm mt-1">{{ form.item_type.errors.as_text }}</div>{% endif %}
            </div>

            {# Dynamic attributes container - populated via HTMX when item type is selected #}
            <div id="dynamic-attributes-container" class="mb-4"></div>
            {% endif %}

            <div class="form-control w-full mb-4">
                <label class="label" for="{{ form.status.id_for_label }}"><span class="label-text">{{ form.status.label }}</span></label>
                {% render_field form.status class="select select-bordered w-full" %}
                {% if form.status.errors %}<div class="text-error text-sm mt-1">{{ form.status.errors.as_text }}</div>{% endif %}
            </div>

            <div class="form-control w-full mb-4">
                <label class="label" for="{{ form.description.id_for_label }}"><span class="label-text">{{ form.description.label }}</span></label>
                {% render_field form.description class="textarea textarea-bordered w-full h-24" placeholder="e.g., First appearance of Superman. Good condition." %}
                {% if form.description.errors %}<div class="text-error text-sm mt-1">{{ form.description.errors.as_text }}</div>{% endif %}
            </div>

            <div class="form-control w-full mb-4">
                <label class="label" for="{{ form.image_url.id_for_label }}"><span class="label-text">{{ form.image_url.label }}</span></label>
                {% render_field form.image_url class="input input-bordered w-full" placeholder="https://" %}
                {% if form.image_url.errors %}<div class="text-error text-sm mt-1">{{ form.image_url.errors.as_text }}</div>{% endif %}
            </div>

            {% if not item %}
            <div class="form-control w-full mb-4">
                <label class="label" for="{{ form.link_url.id_for_label }}">
                    <span class="label-text">{{ form.link_url.label }}</span>
                </label>
                {% render_field form.link_url class="input input-bordered w-full" placeholder="https://example.com" %}
                <label class="label">
                    <span class="label-text-alt">{{ form.link_url.help_text }}</span>
                </label>
                {% if form.link_url.errors %}<div class="text-error text-sm mt-1">{{ form.link_url.errors.as_text }}</div>{% endif %}
            </div>
            {% endif %}

            {# Task 50: Personal Information Fields #}
            <div class="divider">Personal Information</div>

            <div class="form-control w-full mb-4">
                <label class="label" for="{{ form.your_id.id_for_label }}"><span class="label-text">{{ form.your_id.label }}</span></label>
                {% render_field form.your_id class="input input-bordered w-full" placeholder="Your personal identifier" %}
                <label class="label">
                    <span class="label-text-alt">Optional: Your own ID/reference for this item</span>
                </label>
                {% if form.your_id.errors %}<div class="text-error text-sm mt-1">{{ form.your_id.errors.as_text }}</div>{% endif %}
            </div>

            <div class="form-control w-full mb-4">
                <label class="label"><span class="label-text">{{ form.location.label }}</span></label>
                <input type="hidden" name="location" id="form_location_id" value="{{ form.location.value|default:'' }}">
                <div class="relative">
                    <input type="text"
                           id="form_location_search"
                           name="location_name"
                           class="input input-bordered w-full"
                           placeholder="Type location name..."
                           value="{% if form.instance.location %}{{ form.instance.location.name }}{% endif %}"
                           autocomplete="off"
                           hx-get="{% url 'location_autocomplete' %}"
                           hx-trigger="keyup changed delay:300ms"
                           hx-target="#form_location_results"
                           hx-vals='js:{"q": document.getElementById("form_location_search").value}'
                           onblur="setTimeout(() => document.getElementById('form_location_results').classList.add('hidden'), 200)">
                    <div id="form_location_results"
                         class="absolute z-50 w-full bg-base-100 shadow-lg rounded-box mt-1 max-h-60 overflow-y-auto border border-base-300 hidden">
                        <!-- Autocomplete results will appear here -->
                    </div>
                </div>
                <label class="label">
                    <span class="label-text-alt">
                        Type to search existing locations, or enter a new name to create one.
                    </span>
                </label>
                {% if form.location.errors %}<div class="text-error text-sm mt-1">{{ form.location.errors.as_text }}</div>{% endif %}
            </div>

            <button type="submit" class="btn btn-primary">
                {% if form.instance.pk %}
                    {% lucide 'save' size=16 class='mr-2' %} Save Changes
                {% else %}
                    Add Item to Collection
                {% endif %}
            </button>
        </fieldset>
    </form>
</div>

<script>
// Define functions only if modal version hasn't been loaded yet
// Modal version (from _item_edit_location.html) will override these when loaded
if (typeof selectLocationAndSubmit === 'undefined') {
    window.selectLocationAndSubmit = function(id, name) {
        // For main form (item create/edit page), just set the value (don't auto-submit)
        if (document.getElementById('form_location_id')) {
            document.getElementById('form_location_id').value = id;
            document.getElementById('form_location_search').value = name;
            document.getElementById('form_location_results').classList.add('hidden');
        }
        // For modal form (item detail page), set and submit
        else if (document.getElementById('location_value')) {
            document.getElementById('location_value').value = id;
            document.getElementById('location_search').value = name;
            document.getElementById('location_results').classList.add('hidden');
            // Modal will close automatically via hx-on::after-request
            const form = document.getElementById('location_search').closest('form');
            if (form) {
                htmx.trigger(form, 'submit');
            }
        }
    };
}

if (typeof clearLocation === 'undefined') {
    window.clearLocation = function() {
        if (document.getElementById('location_value')) {
            document.getElementById('location_value').value = '';
            document.getElementById('location_search').value = '';
        } else if (document.getElementById('form_location_id')) {
            document.getElementById('form_location_id').value = '';
            document.getElementById('form_location_search').value = '';
        }
    };
}

// Clear hidden location ID when user manually types (to allow creating new location)
if (document.getElementById('form_location_search')) {
    document.getElementById('form_location_search').addEventListener('input', function() {
        // Clear the hidden ID field so backend knows this is a manually typed name
        if (document.getElementById('form_location_id')) {
            document.getElementById('form_location_id').value = '';
        }
    });
}
</script>
{% endblock %}