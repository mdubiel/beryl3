{% extends "base.html" %}
{% load i18n %}
{% load lucide %}
{% load widget_tweaks %}

{% block title %}{% if item %}Edit Item{% else %}Add Item to {{ collection.name }}{% endif %}{% endblock %}

{% block breadcrumbs %}
    <li><a href="{% url 'collection_list' %}">{% lucide 'layout-list' size=16 %} All Collections</a></li>
    <li><a href="{{ collection.get_absolute_url }}">{% lucide 'package' size=16 %} {{ collection.name|truncatechars:20 }}</a></li>
    <li>
        <span class="inline-flex gap-2 items-center">
            {% if item %}
                {% lucide 'pencil' size=16 %} Edit Item
            {% else %}
                {% lucide 'plus' size=16 %} Add New Item
            {% endif %}
        </span>
    </li>
{% endblock breadcrumbs %}


{% block content %}
<div class="flex justify-center">
    <form method="post" class="w-full">
        {% csrf_token %}
        <fieldset class="fieldset bg-base-200 border-base-300 rounded-box w-full max-w-2xl mx-auto border p-6">
            
            <legend class="fieldset-legend">
                {% if item %}Edit {{ item.name }}{% else %}Add New Item to "{{ collection.name }}"{% endif %}
            </legend>
            
{% if form.non_field_errors %}<div class="alert alert-error my-2"><span>{{ form.non_field_errors.as_text }}</span></div>{% endif %}

            <div class="form-control w-full mb-4">
                <label class="label" for="{{ form.name.id_for_label }}"><span class="label-text">{{ form.name.label }}</span></label>
                {% render_field form.name class="input input-bordered w-full" placeholder="e.g., Action Comics #1" %}
                {% if form.name.errors %}<div class="text-error text-sm mt-1">{{ form.name.errors.as_text }}</div>{% endif %}
            </div>

            {% if not item %}
            <div class="form-control w-full mb-4">
                <label class="label" for="{{ form.item_type.id_for_label }}"><span class="label-text">{{ form.item_type.label }}</span></label>
                {% render_field form.item_type class="select select-bordered w-full" hx-get="/items/get-type-attributes/" hx-target="#dynamic-attributes-container" hx-trigger="change" hx-swap="innerHTML" %}
                {% if form.item_type.errors %}<div class="text-error text-sm mt-1">{{ form.item_type.errors.as_text }}</div>{% endif %}
            </div>

            {# Dynamic attributes container - populated via HTMX when item type is selected #}
            <div id="dynamic-attributes-container" class="mb-4"></div>
            {% endif %}

            <div class="form-control w-full mb-4">
                <label class="label" for="{{ form.status.id_for_label }}"><span class="label-text">{{ form.status.label }}</span></label>
                {% render_field form.status class="select select-bordered w-full" %}
                {% if form.status.errors %}<div class="text-error text-sm mt-1">{{ form.status.errors.as_text }}</div>{% endif %}
            </div>

            <div class="form-control w-full mb-4">
                <label class="label" for="{{ form.description.id_for_label }}"><span class="label-text">{{ form.description.label }}</span></label>
                {% render_field form.description class="textarea textarea-bordered w-full h-24" placeholder="e.g., First appearance of Superman. Good condition." %}
                {% if form.description.errors %}<div class="text-error text-sm mt-1">{{ form.description.errors.as_text }}</div>{% endif %}
            </div>

            <div class="form-control w-full mb-4">
                <label class="label" for="{{ form.image_url.id_for_label }}"><span class="label-text">{{ form.image_url.label }}</span></label>
                {% render_field form.image_url class="input input-bordered w-full" placeholder="https://" %}
                {% if form.image_url.errors %}<div class="text-error text-sm mt-1">{{ form.image_url.errors.as_text }}</div>{% endif %}
            </div>

            {% if not item %}
            <div class="form-control w-full mb-4">
                <label class="label" for="{{ form.link_url.id_for_label }}">
                    <span class="label-text">{{ form.link_url.label }}</span>
                </label>
                {% render_field form.link_url class="input input-bordered w-full" placeholder="https://example.com" %}
                <label class="label">
                    <span class="label-text-alt">{{ form.link_url.help_text }}</span>
                </label>
                {% if form.link_url.errors %}<div class="text-error text-sm mt-1">{{ form.link_url.errors.as_text }}</div>{% endif %}
            </div>
            {% endif %}

            {# Task 50: Personal Information Fields #}
            <div class="divider">Personal Information</div>

            <div class="form-control w-full mb-4">
                <label class="label" for="{{ form.your_id.id_for_label }}"><span class="label-text">{{ form.your_id.label }}</span></label>
                {% if suggested_id %}
                    {% render_field form.your_id class="input input-bordered w-full" placeholder=suggested_id %}
                {% else %}
                    {% render_field form.your_id class="input input-bordered w-full" placeholder="Your personal identifier" %}
                {% endif %}
                <label class="label">
                    <span class="label-text-alt">
                        {% if suggested_id %}
                            Suggested: <strong>{{ suggested_id }}</strong>{% if last_used_id %} (last used: {{ last_used_id }}){% endif %}
                        {% else %}
                            Optional: Your own ID/reference for this item
                        {% endif %}
                    </span>
                </label>
                {% if form.your_id.errors %}<div class="text-error text-sm mt-1">{{ form.your_id.errors.as_text }}</div>{% endif %}
            </div>

            <div class="form-control w-full mb-4">
                <label class="label"><span class="label-text">{{ form.location.label }}</span></label>
                <input type="hidden" name="location" id="combobox-form-location-value" value="{{ form.location.value|default:'' }}">
                <input type="hidden" name="location_name" id="combobox-form-location-name" value="">
                <div class="relative">
                    <input type="text"
                           id="combobox-form-location-search"
                           name="q"
                           class="input input-bordered w-full"
                           placeholder="Type location name..."
                           value="{% if form.instance.location %}{{ form.instance.location.name }}{% endif %}"
                           autocomplete="off"
                           data-combobox="form-location"
                           hx-get="{% url 'location_autocomplete' %}"
                           hx-trigger="keyup changed delay:300ms, input changed delay:300ms"
                           hx-target="#combobox-form-location-results"
                           hx-swap="innerHTML"
                           hx-include="this">
                    <div id="combobox-form-location-results"
                         class="absolute w-full bg-base-100 shadow-lg rounded-box mt-1 max-h-60 overflow-y-auto border border-base-300 hidden z-[9999]">
                        <!-- Autocomplete results will appear here -->
                    </div>
                </div>
                <label class="label">
                    <span class="label-text-alt">
                        Type to search existing locations, or enter a new name to create one.
                    </span>
                </label>
                {% if form.location.errors %}<div class="text-error text-sm mt-1">{{ form.location.errors.as_text }}</div>{% endif %}
            </div>

            <button type="submit" class="btn btn-primary">
                {% if form.instance.pk %}
                    {% lucide 'save' size=16 class='mr-2' %} Save Changes
                {% else %}
                    Add Item to Collection
                {% endif %}
            </button>
        </fieldset>
    </form>
</div>

<script>
// Task 50: Ensure location name is submitted when user types (not selects from autocomplete)
document.addEventListener('DOMContentLoaded', function() {
    const form = document.querySelector('form');
    const locationSearch = document.getElementById('combobox-form-location-search');
    const locationName = document.getElementById('combobox-form-location-name');
    const locationValue = document.getElementById('combobox-form-location-value');

    if (form && locationSearch && locationName) {
        form.addEventListener('submit', function(e) {
            // If user typed but didn't select from autocomplete (value is empty but search has text)
            if (!locationValue.value && locationSearch.value) {
                // Copy the typed text to location_name so backend can process it
                locationName.value = locationSearch.value;
            }
        });
    }
});
</script>
{% endblock %}