{% extends "base.html" %}
{% load static %}
{% load i18n %}
{% load lucide %}
{% load markdown_tags %}
{% load media_tags %}

{% block title %}{{ collection.name }}{% endblock %}

{% block breadcrumbs %}
    <li>
        <a href="{% url 'collection_list' %}">
            {% lucide 'layout-list' size=16 %}
            All Collections
        </a>
    </li>
    <li>
        {# Active page #}
        <span class="inline-flex gap-2 items-center">
            {% lucide 'package' size=16 %}
            {{ collection.name|truncatechars:25 }}
        </span>
    </li>
{% endblock breadcrumbs %}

{% block content %}

{# Top action buttons (owner) #}
{% if request.user == collection.created_by %}
<div class="mb-8 flex items-center justify-end gap-2">
    {# Main Actions Group #}
    <div class="btn-group">
        <a href="{% url "item_create" collection.hash %}" class="btn btn-secondary btn-sm">
            {% lucide 'plus' size=16 class='mr-2' %} Add New Item
        </a>
        
        <div id="visibility-dropdown-{{ collection.hash }}" class="dropdown dropdown-end dropdown-bottom">
            <button tabindex="0" class="btn btn-ghost btn-square btn-sm" title="Change Visibility">
                {% lucide 'share-2' size=18 %}
            </button>
            <ul tabindex="0" class="dropdown-content menu p-2 shadow bg-base-100 rounded-box w-52 z-10">
                <li class="menu-title"><span>Change Visibility</span></li>
                {% for visibility_value, visibility_label in collection.Visibility.choices %}
                <li>
                    {% if collection.visibility == visibility_value %}
                        <a class="disabled font-bold">{{ visibility_label }}</a>
                    {% else %}
                        <a  hx-post="{% url 'collection_update_visibility' collection.hash %}"
                            hx-vals='{"new_visibility": "{{ visibility_value }}"}'
                            hx-target="#visibility-dropdown-{{ collection.hash }}"
                            hx-swap="outerHTML"
                            hx-headers='{"X-CSRFToken": "{{ csrf_token }}"}'>
                            {{ visibility_label }}
                        </a>
                    {% endif %}
                </li>
                {% endfor %}
            </ul>
        </div>
        
        <a href="{% url "collection_manage_images" collection.hash %}" class="btn btn-ghost btn-square btn-sm" title="Manage Images">
            {% lucide 'images' size=18 %}
        </a>
        
        <a href="{% url "collection_update" collection.hash %}" class="btn btn-ghost btn-square btn-sm" title="Edit Collection">
            {% lucide 'pencil' size=18 %}
        </a>
    </div>

    {# Danger Actions Group - Delete #}
    <div class="btn-group">
        {% include "partials/_collection_delete_dropdown.html" with collection=collection %}
    </div>
</div>
{% endif %}


{# Collection Hero Card - Image Always On Top #}
<div class="bg-base-100 rounded-lg min-w-80 max-w-none mx-auto lg:mx-0 mb-8">
    
    {# Image section using DaisyUI figure - Always on top #}
    <figure class="w-full h-64 rounded-t-lg overflow-hidden">
        {% if collection.default_image %}
            <img src="{% media_url collection.default_image.media_file %}" 
                 alt="{{ collection.name }}" 
                 class="w-full h-full object-cover cursor-pointer"
                 onclick="showImageModal('{% media_url collection.default_image.media_file %}', '{{ collection.name|escapejs }}')" />
        {% elif collection.images.all.0 %}
            <img src="{% media_url collection.images.all.0.media_file %}" 
                 alt="{{ collection.name }}" 
                 class="w-full h-full object-cover cursor-pointer"
                 onclick="showImageModal('{% media_url collection.images.all.0.media_file %}', '{{ collection.name|escapejs }}')" />
        {% else %}
            <div class="w-full h-full bg-base-300 flex items-center justify-center rounded-t-lg">
                {% lucide 'image' size=64 class='text-neutral' %}
            </div>
        {% endif %}
    </figure>
    
    {# Content section using DaisyUI card-body #}
    <div class="card-body flex flex-col justify-between py-8 px-4">
        
        {# Top section #}
        <div class="space-y-6">
            
            <h1 class="text-5xl font-bold leading-tight">{{ collection.name }}</h1>
            
            <div id="share-section-{{ collection.hash }}" class="share-section">
            {% if collection.visibility != 'PRIVATE' %}
            {# Task 54: Mobile-responsive share URL controls #}
            <div class="mt-3 flex flex-col sm:flex-row items-center lg:items-start gap-2">
                <div class="join w-full sm:w-auto">
                    <input type="text" value="{{ collection.get_sharable_url }}" readonly class="input input-sm input-bordered join-item text-xs w-full sm:w-96" />
                    <button class="btn btn-sm join-item" onclick="copyToClipboard(this.previousElementSibling, this)">
                        {% lucide 'copy' size=14 %}
                    </button>
                    <a href="{{ collection.get_sharable_url }}" target="_blank" class="btn btn-sm join-item" title="Open public view">
                        {% lucide 'external-link' size=14 %}
                    </a>
                    <div class="btn btn-sm join-item gap-1 {% if collection.visibility == 'PUBLIC' %}btn-accent{% else %}btn-info{% endif %} cursor-default">
                        {% lucide 'globe' size=12 %}
                        <span class="hidden sm:inline">{{ collection.get_visibility_display }}</span>
                    </div>
                </div>
            </div>
            {% endif %}
            </div>
            
            <p class="text-base-content text-neutral">{{ collection.description|default:"No description provided."|markdown_safe }}</p>
            
            {# Collection Images Gallery - Smaller Size #}
            {% if collection.images.all %}
            <div class="mt-6">
                <h3 class="text-sm font-semibold mb-3 text-base-content text-neutral">Collection Images</h3>
                <div class="grid grid-cols-4 sm:grid-cols-6 lg:grid-cols-8 gap-2">
                    {% for image in collection.images.all %}
                    <div class="aspect-square bg-base-200 rounded-md overflow-hidden cursor-pointer hover:opacity-90 transition-opacity" 
                         onclick="showImageModal('{% media_url image.media_file %}', '{{ collection.name|escapejs }} - Image {{ forloop.counter }}')">
                        <img src="{% media_url image.media_file %}" 
                             alt="{{ collection.name }} - Image {{ forloop.counter }}" 
                             class="w-full h-full object-cover" />
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}
            
        </div>
        
        {# Bottom section - Stats - flex-wrap without borders #}
        <div class="mt-6">
            <div class="flex flex-wrap gap-4">
                <div class="stat bg-base-100/60 backdrop-blur-sm p-4 flex-1 min-w-[120px]">
                    <div class="stat-title">Total Items</div>
                    <div class="stat-value">{{ stats.total_items }}</div>
                </div>
                <div class="stat bg-base-100/60 backdrop-blur-sm p-4 flex-1 min-w-[120px]">
                    <div class="stat-title">In Collection</div>
                    <div class="stat-value text-success">{{ stats.in_collection_count }}</div>
                </div>
                <div class="stat bg-base-100/60 backdrop-blur-sm p-4 flex-1 min-w-[120px]">
                    <div class="stat-title">Wanted</div>
                    <div class="stat-value text-info">{{ stats.wanted_count }}</div>
                </div>
                <div class="stat bg-base-100/60 backdrop-blur-sm p-4 flex-1 min-w-[120px]">
                    <div class="stat-title">Reserved</div>
                    <div class="stat-value text-warning">{{ stats.reserved_count }}</div>
                </div>
            </div>
        </div>
        
    </div>
    
</div>


{# Items listing #}
<div class="mt-12">
    <div class="flex items-center justify-between mb-4">
        <h2 class="text-2xl font-bold">Items in this Collection</h2>
        {% if stats.total_items > 0 %}
        <span class="text-sm text-base-content/70">Showing {{ items.start_index }}-{{ items.end_index }} of {{ stats.total_items }} items</span>
        {% endif %}
    </div>

    {# Task 52: Smart attribute filter badges #}
    {% if attribute_stats and stats.total_items > 0 %}
    <div class="mb-6">
        <h3 class="text-sm font-semibold mb-3 text-neutral">Quick Filters</h3>
        <div class="flex flex-wrap gap-2">
            {% for stat in attribute_stats %}
            <a href="?attribute={{ stat.attribute_id }}&attribute_value={{ stat.value|urlencode }}{% if filter_search %}&search={{ filter_search|urlencode }}{% endif %}{% if filter_status %}&status={{ filter_status }}{% endif %}{% if filter_item_type %}&item_type={{ filter_item_type }}{% endif %}"
               class="badge badge-lg gap-1 cursor-pointer hover:badge-primary transition-colors
                      {% if filter_attribute == stat.attribute_id|stringformat:'s' and filter_attribute_value == stat.value %}badge-primary{% else %}badge-ghost{% endif %}">
                <span class="text-xs">{{ stat.attribute_name }}: {{ stat.display_value }}</span>
                <span class="badge badge-sm {% if filter_attribute == stat.attribute_id|stringformat:'s' and filter_attribute_value == stat.value %}badge-neutral{% else %}badge-ghost{% endif %}">{{ stat.count }}</span>
            </a>
            {% endfor %}
        </div>
        {% if filter_attribute %}
        <div class="mt-2">
            <a href="?{% if filter_search %}search={{ filter_search|urlencode }}&{% endif %}{% if filter_status %}status={{ filter_status }}&{% endif %}{% if filter_item_type %}item_type={{ filter_item_type }}{% endif %}"
               class="btn btn-ghost btn-xs">
                {% lucide 'x' size=12 %} Clear Attribute Filter
            </a>
        </div>
        {% endif %}
    </div>
    {% endif %}

    {# Task 45: Filtering UI - Enhanced with available filters only #}
    {# Show filter panel if collection has items OR if filters are active #}
    {% if stats.total_items > 0 or filter_search or filter_status or filter_item_type or filter_attribute %}
    <div class="card bg-base-200 shadow-sm p-4 mb-6">
        <form method="get" id="filter-form">
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-6 gap-4">
                {# Search filter #}
                <div class="form-control">
                    <label class="label"><span class="label-text">Search</span></label>
                    <input type="text" name="search" value="{{ filter_search }}" placeholder="Search by name..." class="input input-bordered input-sm">
                </div>

                {# Status filter - Task 45: Show only available statuses #}
                <div class="form-control">
                    <label class="label"><span class="label-text">Status</span></label>
                    <select name="status" class="select select-bordered select-sm">
                        <option value="">All Statuses</option>
                        {% for status_value, status_label in status_choices %}
                        {% if status_value in available_statuses %}
                        <option value="{{ status_value }}" {% if filter_status == status_value %}selected{% endif %}>
                            {{ status_label }}
                        </option>
                        {% endif %}
                        {% endfor %}
                    </select>
                </div>

                {# Item Type filter - Task 45: Show only available item types #}
                <div class="form-control">
                    <label class="label"><span class="label-text">Item Type</span></label>
                    <select name="item_type" class="select select-bordered select-sm">
                        <option value="">All Types</option>
                        {% if has_items_without_type %}
                        <option value="none" {% if filter_item_type == 'none' %}selected{% endif %}>No Type</option>
                        {% endif %}
                        {% for item_type in available_item_types %}
                        <option value="{{ item_type.id }}" {% if filter_item_type == item_type.id|stringformat:"s" %}selected{% endif %}>
                            {{ item_type.display_name }}
                        </option>
                        {% endfor %}
                    </select>
                </div>

                {# Attribute filter - Task 45: Add attribute filter dropdown #}
                <div class="form-control">
                    <label class="label"><span class="label-text">Filter by Attribute</span></label>
                    <select name="attribute" id="attribute-filter" class="select select-bordered select-sm" onchange="var valueField = document.getElementsByName('attribute_value')[0]; if (valueField) valueField.value=''; this.form.submit()">
                        <option value="">Select Attribute...</option>
                        {% for attribute in available_attributes %}
                        <option value="{{ attribute.id }}" {% if filter_attribute == attribute.id|stringformat:"s" %}selected{% endif %}>
                            {{ attribute.display_name }}
                        </option>
                        {% endfor %}
                    </select>
                </div>

                {# Attribute value filter - Task 45: Show only when attribute selected #}
                {% if filter_attribute and available_attribute_values %}
                <div class="form-control">
                    <label class="label"><span class="label-text">Attribute Value</span></label>
                    <select name="attribute_value" class="select select-bordered select-sm">
                        <option value="">All Values</option>
                        {% for value in available_attribute_values %}
                        <option value="{{ value }}" {% if filter_attribute_value == value %}selected{% endif %}>
                            {% if value|length > 30 %}{{ value|truncatechars:30 }}{% else %}{{ value }}{% endif %}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                {% endif %}

                {# Filter buttons #}
                <div class="form-control flex flex-col justify-end">
                    <label class="label">&nbsp;</label>
                    <div class="flex gap-2">
                        <button type="submit" class="btn btn-primary btn-sm flex-1">
                            {% lucide 'filter' size=14 class='mr-1' %} Filter
                        </button>
                        <a href="?" class="btn btn-ghost btn-sm">
                            {% lucide 'x' size=14 %} Clear
                        </a>
                    </div>
                </div>
            </div>
        </form>
    </div>
    {% endif %}

    <div class="flex flex-col gap-6">
        {# Task 47: Show grouped or ungrouped items - with progressive loading #}
        {% if item_hashes_grouped %}
            {# Display items grouped by attribute values - progressive loading #}
            {% for group in item_hashes_grouped %}
                {# Group header #}
                <h3 class="text-lg font-semibold flex items-center gap-2 mt-2">
                    {% lucide 'layers' size=20 %}
                    {{ group.attribute_name %}{% if group.attribute_value %}: {{ group.attribute_value %}{% endif %}
                    <span class="badge badge-neutral badge-sm ml-2">{{ group.item_hashes|length }} items</span>
                </h3>

                {# Group items - progressive loading #}
                {% for item_hash in group.item_hashes %}
                    <div id="item-{{ item_hash }}-container"
                         class="min-h-[200px]"
                         hx-get="{% url 'load_private_item_card' item_hash %}"
                         hx-trigger="intersect once"
                         hx-swap="innerHTML">
                        {# Loading placeholder #}
                        <div class="flex items-center justify-center h-48">
                            <span class="loading loading-spinner loading-lg text-primary"></span>
                        </div>
                    </div>
                {% endfor %}
            {% endfor %}
        {% elif item_hashes %}
            {# Regular ungrouped display - progressive loading #}
            {% for item_hash in item_hashes %}
                <div id="item-{{ item_hash }}-container"
                     class="min-h-[200px]"
                     hx-get="{% url 'load_private_item_card' item_hash %}"
                     hx-trigger="intersect once"
                     hx-swap="innerHTML">
                    {# Loading placeholder #}
                    <div class="flex items-center justify-center h-48">
                        <span class="loading loading-spinner loading-lg text-primary"></span>
                    </div>
                </div>
            {% empty %}
                <div class="card bg-base-100 shadow-sm p-8 text-center">
                    <p class="text-base-content text-neutral">
                        {% if filter_search or filter_status or filter_item_type %}
                            No items match your filters.
                        {% else %}
                            This collection has no items yet.
                        {% endif %}
                    </p>
                </div>
            {% endfor %}
        {% else %}
            {# No items #}
            <div class="card bg-base-100 shadow-sm p-8 text-center">
                <p class="text-base-content text-neutral">
                    {% if filter_search or filter_status or filter_item_type %}
                        No items match your filters.
                    {% else %}
                        This collection has no items yet.
                    {% endif %}
                </p>
            </div>
        {% endif %}
    </div>

    {# Task 46: Pagination UI #}
    {% if page_obj.has_other_pages %}
    <div class="flex flex-col md:flex-row items-center justify-between mt-8 gap-4">
        {# Page navigation #}
        <div class="join">
            {% if page_obj.has_previous %}
            <a href="?page=1{% if filter_search %}&search={{ filter_search }}{% endif %}{% if filter_status %}&status={{ filter_status }}{% endif %}{% if filter_item_type %}&item_type={{ filter_item_type }}{% endif %}&per_page={{ items_per_page }}" class="join-item btn btn-sm bg-base-100">«</a>
            <a href="?page={{ page_obj.previous_page_number }}{% if filter_search %}&search={{ filter_search }}{% endif %}{% if filter_status %}&status={{ filter_status }}{% endif %}{% if filter_item_type %}&item_type={{ filter_item_type }}{% endif %}&per_page={{ items_per_page }}" class="join-item btn btn-sm bg-base-100">‹</a>
            {% endif %}

            <button class="join-item btn btn-sm bg-base-100 cursor-default">Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}</button>

            {% if page_obj.has_next %}
            <a href="?page={{ page_obj.next_page_number }}{% if filter_search %}&search={{ filter_search }}{% endif %}{% if filter_status %}&status={{ filter_status }}{% endif %}{% if filter_item_type %}&item_type={{ filter_item_type }}{% endif %}&per_page={{ items_per_page }}" class="join-item btn btn-sm bg-base-100">›</a>
            <a href="?page={{ page_obj.paginator.num_pages }}{% if filter_search %}&search={{ filter_search }}{% endif %}{% if filter_status %}&status={{ filter_status }}{% endif %}{% if filter_item_type %}&item_type={{ filter_item_type }}{% endif %}&per_page={{ items_per_page }}" class="join-item btn btn-sm bg-base-100">»</a>
            {% endif %}
        </div>

        {# Items per page selector #}
        <div class="form-control">
            <select onchange="window.location.href='?page=1{% if filter_search %}&search={{ filter_search }}{% endif %}{% if filter_status %}&status={{ filter_status }}{% endif %}{% if filter_item_type %}&item_type={{ filter_item_type }}{% endif %}&per_page=' + this.value" class="select select-bordered select-sm bg-base-100">
                <option value="10" {% if items_per_page == 10 %}selected{% endif %}>10 per page</option>
                <option value="25" {% if items_per_page == 25 %}selected{% endif %}>25 per page</option>
                <option value="50" {% if items_per_page == 50 %}selected{% endif %}>50 per page</option>
                <option value="100" {% if items_per_page == 100 %}selected{% endif %}>100 per page</option>
            </select>
        </div>
    </div>
    {% endif %}
</div>
{# End items list #}

{# Modal for attribute editing #}
<dialog id="attribute-edit-modal" class="modal">
    <div class="modal-box">
        <h3 class="font-bold text-lg">Edit Attribute</h3>
        <div id="attribute-edit-modal-content">
            <!-- Content will be loaded here via HTMX -->
        </div>
        <div class="modal-action">
            <form method="dialog">
                <button class="btn">Close</button>
            </form>
        </div>
    </div>
</dialog>

{# Modal for move/copy operations #}
<dialog id="move-copy-modal" class="modal">
    <div class="modal-box">
        <h3 class="font-bold text-lg" id="move-copy-modal-title">Move Item</h3>
        <div class="py-4">
            <p class="mb-4">Select the destination collection for <span id="move-copy-item-name" class="font-semibold"></span>:</p>
            
            <div id="collections-loading" class="flex justify-center py-4">
                <span class="loading loading-spinner loading-md"></span>
            </div>
            
            <div id="collections-list" class="space-y-2 max-h-64 overflow-y-auto" style="display: none;">
                <!-- Collections will be loaded here -->
            </div>
            
            <div id="move-copy-error" class="alert alert-error mt-4" style="display: none;">
                <span>Error loading collections. Please try again.</span>
            </div>
        </div>
        <div class="modal-action">
            <form method="dialog">
                <button class="btn">Cancel</button>
            </form>
        </div>
    </div>
</dialog>

{# Confirmation modal for successful operations #}
<dialog id="confirmation-modal" class="modal">
    <div class="modal-box">
        <h3 class="font-bold text-lg text-success">✅ Success!</h3>
        <div class="py-4">
            <p id="confirmation-message" class="mb-6">Operation completed successfully.</p>
            <div class="flex flex-col sm:flex-row gap-3">
                <a id="go-to-collection-link" href="#" class="btn btn-primary flex-1">
                    {% lucide 'folder' size=16 class='mr-2' %}
                    Go to Collection
                </a>
                <a id="view-item-link" href="#" class="btn btn-outline flex-1">
                    {% lucide 'eye' size=16 class='mr-2' %}
                    View Item Details
                </a>
                <button onclick="stayInCurrentCollection()" class="btn btn-outline flex-1">
                    {% lucide 'house' size=16 class='mr-2' %}
                    Stay Here
                </button>
            </div>
        </div>
        <div class="modal-action">
            <form method="dialog">
                <button class="btn btn-sm btn-ghost">Close</button>
            </form>
        </div>
    </div>
    <form method="dialog" class="modal-backdrop">
        <button>close</button>
    </form>
</dialog>

{# Modal for item type selection #}
<dialog id="item-type-modal" class="modal">
    <div class="modal-box max-w-2xl">
        <h3 class="font-bold text-lg">Change Item Type</h3>
        <div class="py-4">
            <p class="mb-4">Select type for <span id="item-type-item-name" class="font-semibold"></span>:</p>

            {# Search input #}
            <input type="text" id="item-type-search" placeholder="Search item types..." class="input input-bordered w-full mb-4" oninput="filterItemTypes()">

            {# Item types grid #}
            <div id="item-types-grid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-2 max-h-96 overflow-y-auto">
                {% for item_type in item_types|dictsort:"display_name" %}
                <button type="button"
                        class="btn btn-ghost btn-sm justify-start item-type-option hover:bg-base-200"
                        data-type-id="{{ item_type.id }}"
                        data-type-name="{{ item_type.display_name|lower }}"
                        onclick="selectItemType('{{ item_type.id }}', '{{ item_type.display_name|escapejs }}')">
                    {% lucide item_type.icon size=16 class='mr-1' %}
                    <span class="truncate">{{ item_type.display_name }}</span>
                </button>
                {% endfor %}
            </div>
        </div>
        <div class="modal-action">
            <form method="dialog">
                <button class="btn">Cancel</button>
            </form>
        </div>
    </div>
    <form method="dialog" class="modal-backdrop">
        <button>close</button>
    </form>
</dialog>

{# Image lightbox modal #}
<dialog id="image-modal" class="modal backdrop-blur-sm">
    <div class="fixed inset-0 bg-black bg-opacity-90 flex items-center justify-center p-4">
        {# Close button - top right #}
        <button class="absolute top-4 right-4 z-10 btn btn-circle btn-ghost text-white hover:bg-base-100 hover:bg-opacity-20" 
                onclick="document.getElementById('image-modal').close()" 
                title="Close (ESC)">
            {% lucide 'x' size=24 %}
        </button>
        
        {# Image title and counter - top center #}
        <div class="absolute top-4 left-1/2 transform -translate-x-1/2 z-10 text-white text-lg font-medium text-center px-4 py-2 bg-black bg-opacity-50 rounded-lg" id="image-modal-title">
            Image Preview
        </div>
        <div class="absolute top-16 left-1/2 transform -translate-x-1/2 z-10 text-white text-sm text-center px-3 py-1 bg-black bg-opacity-50 rounded" id="image-modal-counter" style="display: none;">
            1 / 1
        </div>
        
        {# Previous arrow - left side #}
        <button id="lightbox-prev" 
                class="absolute left-4 top-1/2 transform -translate-y-1/2 z-10 btn btn-circle btn-ghost text-white hover:bg-base-100 hover:bg-opacity-20" 
                onclick="navigateLightbox(-1)"
                title="Previous image (←)"
                style="display: none;">
            {% lucide 'chevron-left' size=32 %}
        </button>
        
        {# Next arrow - right side #}
        <button id="lightbox-next" 
                class="absolute right-4 top-1/2 transform -translate-y-1/2 z-10 btn btn-circle btn-ghost text-white hover:bg-base-100 hover:bg-opacity-20" 
                onclick="navigateLightbox(1)"
                title="Next image (→)"
                style="display: none;">
            {% lucide 'chevron-right' size=32 %}
        </button>
        
        {# Main image - centered #}
        <img id="image-modal-img" 
             src="" 
             alt="" 
             class="max-w-full max-h-full object-contain shadow-2xl" 
             title="Use arrow keys to navigate" />
    </div>
    
    {# Backdrop click to close #}
    <form method="dialog" class="modal-backdrop">
        <button>close</button>
    </form>
</dialog>

{# Result notification area #}
<div id="move-copy-result" class="fixed top-4 right-4 z-50" style="display: none;">
    <!-- Success/error messages will appear here -->
</div>

<script>
let currentItemHash = null;
let currentOperation = null;

// Handle attribute form submission via HTMX events
document.addEventListener('DOMContentLoaded', function() {
    // Handle attribute form errors
    document.body.addEventListener('htmx:responseError', function(evt) {
        // Check if this is for an attribute form
        if (evt.detail.target && evt.detail.target.id && evt.detail.target.id.includes('item-attributes-')) {
            const errorDiv = document.getElementById('attribute-form-errors');
            const errorMessage = document.getElementById('attribute-form-error-message');
            
            if (errorDiv && errorMessage) {
                if (evt.detail.xhr.status === 400 || evt.detail.xhr.status === 500) {
                    try {
                        const response = JSON.parse(evt.detail.xhr.responseText);
                        if (response.error) {
                            errorMessage.textContent = response.error;
                            errorDiv.classList.remove('hidden');
                        }
                    } catch (e) {
                        errorMessage.textContent = 'An error occurred while saving the attribute.';
                        errorDiv.classList.remove('hidden');
                    }
                }
            }
        }
    });
    
    // Handle link form errors
    document.body.addEventListener('htmx:responseError', function(evt) {
        // Check if this is for a link form
        if (evt.detail.target && evt.detail.target.id && evt.detail.target.id.includes('item-links-')) {
            const errorDiv = document.getElementById('link-form-errors');
            const errorMessage = document.getElementById('link-form-error-message');
            
            if (errorDiv && errorMessage) {
                if (evt.detail.xhr.status === 400 || evt.detail.xhr.status === 500) {
                    try {
                        const response = JSON.parse(evt.detail.xhr.responseText);
                        if (response.error) {
                            errorMessage.textContent = response.error;
                            errorDiv.classList.remove('hidden');
                        }
                    } catch (e) {
                        errorMessage.textContent = 'An error occurred while saving the link.';
                        errorDiv.classList.remove('hidden');
                    }
                }
            }
        }
    });
    
    // Handle successful attribute and link form submissions
    document.body.addEventListener('htmx:afterSwap', function(evt) {
        // Check if this is for an attribute form and successful
        if (evt.detail.target && evt.detail.target.id && evt.detail.target.id.includes('item-attributes-') && evt.detail.xhr.status === 200) {
            const modal = document.getElementById('attribute-edit-modal');
            if (modal) {
                modal.close();
            }
        }
        
        // Check if this is for a link form and successful
        if (evt.detail.target && evt.detail.target.id && evt.detail.target.id.includes('item-links-') && evt.detail.xhr.status === 200) {
            const modal = document.getElementById('link-edit-modal');
            if (modal) {
                modal.close();
            }
        }
    });
});

function showMoveModal(itemHash, itemName) {
    currentItemHash = itemHash;
    currentOperation = null; // No specific operation - show both buttons
    document.getElementById('move-copy-modal-title').textContent = 'Move or Copy Item';
    document.getElementById('move-copy-item-name').textContent = itemName;
    loadCollectionsForMoveOrCopy(itemHash);
    document.getElementById('move-copy-modal').showModal();
}

function showCopyModal(itemHash, itemName) {
    // Redirect to showMoveModal - same functionality now
    showMoveModal(itemHash, itemName);
}

// Item Type Modal Functions
let currentItemHashForType = null;
let currentItemTypeId = null;

function showItemTypeModal(itemHash, itemName, currentTypeId) {
    currentItemHashForType = itemHash;
    currentItemTypeId = currentTypeId;
    document.getElementById('item-type-item-name').textContent = itemName;
    document.getElementById('item-type-search').value = '';
    filterItemTypes(); // Show all types initially

    // Highlight current type
    document.querySelectorAll('.item-type-option').forEach(btn => {
        if (btn.dataset.typeId === currentTypeId) {
            btn.classList.add('btn-primary');
            btn.classList.remove('btn-ghost');
        } else {
            btn.classList.remove('btn-primary');
            btn.classList.add('btn-ghost');
        }
    });

    document.getElementById('item-type-modal').showModal();
}

function filterItemTypes() {
    const searchTerm = document.getElementById('item-type-search').value.toLowerCase();
    const buttons = document.querySelectorAll('.item-type-option');

    buttons.forEach(button => {
        const typeName = button.dataset.typeName;
        if (typeName.includes(searchTerm)) {
            button.style.display = '';
        } else {
            button.style.display = 'none';
        }
    });
}

function selectItemType(typeId, typeName) {
    if (!currentItemHashForType) return;

    // Close the modal
    document.getElementById('item-type-modal').close();

    // Use HTMX to update the item type
    const itemRow = document.getElementById(`item-row-${currentItemHashForType}`);
    if (itemRow) {
        htmx.ajax('POST', `/items/${currentItemHashForType}/change-type/`, {
            target: `#item-row-${currentItemHashForType}`,
            swap: 'outerHTML',
            values: { 'item_type_id': typeId },
            headers: { 'X-CSRFToken': '{{ csrf_token }}' }
        });
    }
}

function loadCollectionsForMoveOrCopy(itemHash) {
    // Reset UI
    document.getElementById('collections-loading').style.display = 'block';
    document.getElementById('collections-list').style.display = 'none';
    document.getElementById('move-copy-error').style.display = 'none';
    
    fetch(`/items/${itemHash}/collections/`)
        .then(response => response.json())
        .then(data => {
            document.getElementById('collections-loading').style.display = 'none';
            
            if (data.collections && data.collections.length > 0) {
                displayCollections(data.collections);
                document.getElementById('collections-list').style.display = 'block';
            } else {
                document.getElementById('move-copy-error').innerHTML = 
                    '<span>No other collections available. Create another collection first.</span>';
                document.getElementById('move-copy-error').style.display = 'block';
            }
        })
        .catch(error => {
            console.error('Error loading collections:', error);
            document.getElementById('collections-loading').style.display = 'none';
            document.getElementById('move-copy-error').style.display = 'block';
        });
}

function displayCollections(collections) {
    const listElement = document.getElementById('collections-list');
    listElement.innerHTML = '';

    collections.forEach(collection => {
        const collectionDiv = document.createElement('div');
        collectionDiv.className = 'card bg-base-200 p-4';

        collectionDiv.innerHTML = `
            <div class="flex justify-between items-center">
                <div>
                    <h4 class="font-semibold">${collection.name}</h4>
                    <p class="text-sm text-neutral">${collection.item_count} items</p>
                </div>
                <div class="flex gap-2">
                    <button class="btn btn-primary btn-sm btn-square"
                            title="Move here"
                            onclick="performMoveOrCopy(${collection.id}, '${collection.name.replace(/'/g, "\\'")}', 'move')">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M7 18a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h8"/><path d="M14 8V4"/><path d="M9 4h10"/><path d="M9 9h10"/><path d="M9 14h10"/><path d="M17 14v2a2 2 0 0 1-2 2H7"/></svg>
                    </button>
                    <button class="btn btn-secondary btn-sm btn-square"
                            title="Copy here"
                            onclick="performMoveOrCopy(${collection.id}, '${collection.name.replace(/'/g, "\\'")}', 'copy')">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="14" height="14" x="8" y="8" rx="2" ry="2"/><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"/></svg>
                    </button>
                </div>
            </div>
        `;

        listElement.appendChild(collectionDiv);
    });
}

function performMoveOrCopy(targetCollectionId, targetCollectionName, operation) {
    currentOperation = operation; // Set the operation so confirmation message is correct
    const url = `/items/${currentItemHash}/${operation}/`;
    const formData = new FormData();
    formData.append('target_collection_id', targetCollectionId);
    formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);
    
    fetch(url, {
        method: 'POST',
        body: formData,
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        }
    })
    .then(response => response.json())
    .then(data => {
        document.getElementById('move-copy-modal').close();
        
        if (data.success) {
            // Show confirmation modal with navigation options
            showConfirmationModal(data, targetCollectionName);
            
            if (currentOperation === 'move') {
                // Remove the item from current view since it was moved
                const itemRow = document.getElementById(`item-row-${currentItemHash}`);
                if (itemRow) {
                    itemRow.remove();
                }
            }
            // For copy, item stays in current collection
            
        } else {
            showNotification('error', data.error || 'Operation failed');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        document.getElementById('move-copy-modal').close();
        showNotification('error', 'An error occurred. Please try again.');
    });
}

function showConfirmationModal(data, targetCollectionName) {
    const modal = document.getElementById('confirmation-modal');
    const message = document.getElementById('confirmation-message');
    const collectionLink = document.getElementById('go-to-collection-link');
    const itemLink = document.getElementById('view-item-link');
    
    // Set the confirmation message
    const operationText = currentOperation === 'move' ? 'moved to' : 'copied to';
    message.textContent = `Item successfully ${operationText} "${targetCollectionName}".`;
    
    // Set the collection link
    collectionLink.href = data.new_collection_url;
    
    // Set the item link - for moves, use the same item hash in new collection
    // For copies, use the new copied item hash
    if (currentOperation === 'copy' && data.copied_item_hash) {
        itemLink.href = `/items/${data.copied_item_hash}/`;
    } else {
        itemLink.href = `/items/${currentItemHash}/`;
    }
    
    // Show the modal
    modal.showModal();
}

function stayInCurrentCollection() {
    // Close the confirmation modal and reload the page to refresh the item list
    document.getElementById('confirmation-modal').close();
    window.location.reload();
}

function showNotification(type, message) {
    const resultDiv = document.getElementById('move-copy-result');
    const alertClass = type === 'success' ? 'alert-success' : 'alert-error';
    const icon = type === 'success' ? '✅' : '❌';
    
    resultDiv.innerHTML = `
        <div class="alert ${alertClass} shadow-lg">
            <span>${icon} ${message}</span>
        </div>
    `;
    
    resultDiv.style.display = 'block';
    
    // Auto-hide after 5 seconds
    setTimeout(() => {
        resultDiv.style.display = 'none';
    }, 5000);
}

// Image gallery lightbox functionality
let currentGallery = {
    images: [],
    currentIndex: 0,
    itemName: ''
};

function showImageModal(imageUrl, imageTitle) {
    // For backward compatibility - single image
    showImageGallery(0, imageTitle, [imageUrl]);
}

function showImageGallery(startIndex, itemName, imageUrls) {
    currentGallery = {
        images: imageUrls,
        currentIndex: startIndex,
        itemName: itemName
    };
    
    const modal = document.getElementById('image-modal');
    updateLightboxImage();
    modal.showModal();
    
    // Focus the modal for keyboard navigation
    modal.focus();
    
    // Add keyboard event listeners
    const handleKeydown = (e) => {
        switch(e.key) {
            case 'Escape':
                modal.close();
                break;
            case 'ArrowLeft':
                e.preventDefault();
                navigateLightbox(-1);
                break;
            case 'ArrowRight':
                e.preventDefault();
                navigateLightbox(1);
                break;
        }
    };
    document.addEventListener('keydown', handleKeydown);
    
    // Remove event listener when modal closes
    modal.addEventListener('close', () => {
        document.removeEventListener('keydown', handleKeydown);
    }, { once: true });
}

function navigateLightbox(direction) {
    const newIndex = currentGallery.currentIndex + direction;
    
    // Handle wrapping
    if (newIndex < 0) {
        currentGallery.currentIndex = currentGallery.images.length - 1;
    } else if (newIndex >= currentGallery.images.length) {
        currentGallery.currentIndex = 0;
    } else {
        currentGallery.currentIndex = newIndex;
    }
    
    updateLightboxImage();
}

function updateLightboxImage() {
    const img = document.getElementById('image-modal-img');
    const title = document.getElementById('image-modal-title');
    const counter = document.getElementById('image-modal-counter');
    const prevBtn = document.getElementById('lightbox-prev');
    const nextBtn = document.getElementById('lightbox-next');
    
    // Update image
    img.src = currentGallery.images[currentGallery.currentIndex];
    img.alt = `${currentGallery.itemName} - Image ${currentGallery.currentIndex + 1}`;
    
    // Update title
    title.textContent = currentGallery.itemName;
    
    // Update counter and show navigation if multiple images
    if (currentGallery.images.length > 1) {
        counter.textContent = `${currentGallery.currentIndex + 1} / ${currentGallery.images.length}`;
        counter.style.display = 'block';
        prevBtn.style.display = 'block';
        nextBtn.style.display = 'block';
    } else {
        counter.style.display = 'none';
        prevBtn.style.display = 'none';
        nextBtn.style.display = 'none';
    }
}
</script>

{# Link edit modal #}
<dialog id="link-edit-modal" class="modal">
    <div class="modal-box">
        <h3 class="font-bold text-lg">Edit Link</h3>
        <div id="link-edit-modal-content">
            <!-- Content will be loaded here via HTMX -->
        </div>
        <div class="modal-action">
            <form method="dialog">
                <button class="btn">Close</button>
            </form>
        </div>
    </div>
</dialog>

{% endblock %}