{% load lucide %}

<div id="attribute-form-errors" class="alert alert-error hidden mb-4">
    <span id="attribute-form-error-message"></span>
</div>

<form hx-post="{% url 'item_save_attribute' item.hash %}"
      hx-target="#item-attributes-{{ item.hash }}"
      hx-swap="outerHTML"
      hx-headers='{"X-CSRFToken": "{{ csrf_token }}"}'
      class="space-y-4"
      onsubmit="handleAttributeFormSubmit(event)"
      id="attribute-form">
    
    {% if mode == 'add' %}
        <div class="form-control">
            <label class="label">
                <span class="label-text">Attribute</span>
            </label>
            <select name="attribute_name"
                    class="select select-bordered w-full"
                    required
                    hx-get="{% url 'item_get_attribute_input' item.hash %}"
                    hx-target="#attribute-value-input"
                    hx-swap="innerHTML"
                    hx-trigger="change"
                    hx-include="[name='attribute_name']">
                <option value="">Select an attribute...</option>
                {% for attr in available_attributes %}
                    <option value="{{ attr.name }}" data-type="{{ attr.attribute_type }}">{{ attr.display_name }}</option>
                {% endfor %}
            </select>
        </div>

        <div id="attribute-value-input" class="form-control">
            <label class="label">
                <span class="label-text">Value</span>
            </label>
            <input type="text" name="attribute_value" class="input input-bordered w-full" required>
        </div>
    {% else %}
        {# Edit mode #}
        <input type="hidden" name="attribute_name" value="{{ attribute.name }}">
        {% if attr_value_hash %}
        <input type="hidden" name="attr_value_hash" value="{{ attr_value_hash }}">
        {% endif %}

        <div class="form-control">
            <label class="label">
                <span class="label-text">{{ attribute.display_name }}</span>
                {% if attribute.help_text %}
                    <span class="label-text-alt">{{ attribute.help_text }}</span>
                {% endif %}
            </label>
            
            {% if attribute.attribute_type == 'BOOLEAN' %}
                <fieldset class="border border-base-300 rounded-lg p-4">
                    <legend class="text-sm font-semibold px-2">{{ attribute.display_name }}</legend>
                    <div class="flex items-center justify-center gap-4">
                        <span class="label-text text-error">No</span>
                        <input type="checkbox" class="toggle toggle-success" id="attr-edit-toggle" {% if current_value %}checked{% endif %} onchange="document.getElementById('attr-edit-value-hidden').value = this.checked ? '1' : '0'" />
                        <input type="hidden" name="attribute_value" id="attr-edit-value-hidden" value="{% if current_value %}1{% else %}0{% endif %}" />
                        <span class="label-text text-success">Yes</span>
                    </div>
                </fieldset>
            {% elif attribute.attribute_type == 'LONG_TEXT' %}
                <textarea name="attribute_value" class="textarea textarea-bordered w-full" rows="3" 
                          {% if attribute.required %}required{% endif %}>{{ current_value }}</textarea>
            {% elif attribute.attribute_type == 'CHOICE' %}
                <select name="attribute_value" class="select select-bordered w-full" 
                        {% if attribute.required %}required{% endif %}>
                    <option value="">Select...</option>
                    {% for choice in attribute.choices %}
                        <option value="{{ choice }}" {% if choice == current_value %}selected{% endif %}>{{ choice }}</option>
                    {% endfor %}
                </select>
            {% elif attribute.attribute_type == 'DATE' %}
                <input type="date" name="attribute_value" class="input input-bordered w-full" 
                       value="{{ current_value }}" {% if attribute.required %}required{% endif %}>
            {% elif attribute.attribute_type == 'NUMBER' %}
                <input type="number" name="attribute_value" class="input input-bordered w-full" 
                       value="{{ current_value }}" {% if attribute.required %}required{% endif %} step="any">
            {% elif attribute.attribute_type == 'URL' %}
                <input type="url" name="attribute_value" class="input input-bordered w-full" 
                       value="{{ current_value }}" {% if attribute.required %}required{% endif %} 
                       placeholder="https://example.com">
            {% else %}
                {# TEXT or fallback - Task 57: Add autocomplete #}
                <div class="relative">
                    <input type="text" name="attribute_value"
                           id="attr-edit-value-input-{{ attribute.name }}"
                           list="attr-edit-suggestions-{{ attribute.name }}"
                           class="input input-bordered w-full"
                           value="{{ current_value }}"
                           {% if attribute.required %}required{% endif %}
                           placeholder="Type at least 3 characters for suggestions..."
                           autocomplete="off"
                           hx-get="{% url 'item_autocomplete_attribute_value' item.hash %}"
                           hx-trigger="keyup changed delay:300ms[target.value.length >= 3]"
                           hx-target="#attr-edit-suggestions-{{ attribute.name }}"
                           hx-swap="innerHTML"
                           hx-vals='js:{"q": document.getElementById("attr-edit-value-input-{{ attribute.name }}").value, "attribute_name": "{{ attribute.name }}"}'>
                    <datalist id="attr-edit-suggestions-{{ attribute.name }}">
                        {# Suggestions will be loaded here via HTMX #}
                    </datalist>
                </div>
            {% endif %}
        </div>
    {% endif %}
    
    <div class="flex gap-2">
        <button type="submit" class="btn btn-primary">Save</button>
        <button type="button" class="btn btn-ghost" onclick="document.getElementById('attribute-edit-modal').close()">Cancel</button>
    </div>
</form>

<script>
function handleAttributeFormSubmit(event) {
    // Hide any previous errors
    const errorDiv = document.getElementById('attribute-form-errors');
    if (errorDiv) {
        errorDiv.classList.add('hidden');
    }
}
</script>