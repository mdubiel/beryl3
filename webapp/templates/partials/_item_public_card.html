{% load lucide_cached %}
{% load media_tags %}
{% load attribute_tags %}

<div class="card lg:card-side bg-gray-50/85 min-w-80 max-w-md lg:min-w-96 lg:max-w-none mx-auto lg:mx-0 shadow-md hover:shadow-lg transition-shadow rounded-none">
    {# Task 65: Lazy load images with HTMX for better performance #}
    <figure class="lg:w-1/4 w-full h-48 lg:h-auto lg:self-stretch rounded-none relative bg-base-200"
            hx-get="{% url 'lazy_load_item_image' item.hash %}"
            hx-trigger="intersect once"
            hx-swap="innerHTML">
        {# Loading spinner shown while image loads #}
        <div class="absolute inset-0 flex items-center justify-center">
            <span class="loading loading-spinner loading-lg text-primary"></span>
        </div>
    </figure>
    {# Content section using DaisyUI card-body #}
    <div class="card-body lg:w-3/4 flex flex-col justify-between">
        
        {# Top section #}
        <div class="space-y-3">
            
            {# Row 1: Item name with favorite star #}
            <div class="flex flex-wrap lg:flex-nowrap items-start justify-between gap-4">
                <div class="flex flex-col flex-wrap gap-2 pr-4">
                    <div class="flex items-center gap-2 flex-grow">
                        {# Favorite star - display only (not interactive for public view) #}
                        {% if item.is_favorite %}
                        <div class="tooltip" data-tip="Owner's favorite">
                            {% lucide_cached 'star' size=20 class='text-warning fill-current' %}
                        </div>
                        {% endif %}
                        
                        <h2 class="font-bold text-lg leading-tight">
                            {{ item.name }}
                        </h2>
                        
                    </div>
                    {# Row 2: Description #}
                    {% if item.description %}
                    <div>
                        <p class="text-sm opacity-70">{{ item.description }}</p>
                    </div>
                    {% endif %}
                    {# Row 3: Status badge and item type badge #}
                    <div class="flex flex-wrap gap-2">
                        <div class="badge {% if item.status == 'IN_COLLECTION' %}badge-success{% elif item.status == 'WANTED' %}badge-info{% elif item.status == 'RESERVED' %}badge-warning{% else %}badge-neutral{% endif %}">
                            {% lucide_cached 'tag' size=12 class='mr-1' %}
                            {{ item.get_status_display }}
                        </div>
                        {# Item type badge - small screens only #}
                        {% if item.item_type %}
                        <div class="badge badge-secondary lg:hidden">
                            {% lucide_cached item.item_type.icon size=14 class='mr-1' %}
                            {{ item.item_type.display_name }}
                        </div>
                        {% endif %}
                    </div>
                </div>

                {# Item type badge - large screens: icon with label below #}
                {% if item.item_type %}
                <div class="hidden lg:flex flex-col items-center justify-center gap-1 min-w-24 max-w-24">
                    <p>
                        {% lucide_cached item.item_type.icon size=48 class='mr-1' %}
                    </p>
                    <p class="text-center">{{ item.item_type.display_name }}</p>
                </div>
                {% endif %}
            </div>
            

            

            
            {# Row 4: Attributes display (grouped by attribute name) #}
            {% if item.item_type %}
                {% with attributes=item.get_display_attributes|group_attributes %}
                    {% if attributes|length > 0 %}
                        <div class="mt-3">
                            {# Grid layout: attribute names (right-aligned, fixed width) | values (left-aligned) #}
                            <div class="grid grid-cols-[6rem_1fr] lg:grid-cols-[8rem_1fr] gap-y-2">
                                {% for group in attributes %}
                                {# Attribute name - right-aligned, fixed width #}
                                <div class="text-xs font-bold text-right {% if not forloop.last %}border-b border-base-300 pb-2{% endif %}">
                                    {{ group.attribute.display_name }}{{ group.values|length|pluralize }}{% if group.attribute.help_text %}<span class="tooltip tooltip-left ml-1" data-tip="{{ group.attribute.help_text }}">{% lucide_cached 'info' size=12 class='text-neutral opacity-60' %}</span>{% endif %}:
                                </div>

                                {# Values - left-aligned with left padding #}
                                <div class="pl-4 {% if not forloop.last %}border-b border-base-300 pb-2{% endif %}">
                                        {% if group.values|length > 1 %}
                                            {# Multiple values - display as list #}
                                            <div class="space-y-0.5">
                                                {% for value_data in group.values %}
                                                <div class="text-xs">
                                                    {% if group.attribute.attribute_type == 'URL' %}
                                                        <a href="{{ value_data.value }}" target="_blank" class="link link-hover text-primary">
                                                            {{ value_data.value }}
                                                        </a>
                                                    {% elif group.attribute.attribute_type == 'BOOLEAN' %}
                                                        {% if value_data.value %}
                                                            <span class="flex items-center gap-1 text-success font-semibold">
                                                                {% lucide_cached 'circle-check' size=14 %}
                                                                Yes
                                                            </span>
                                                        {% else %}
                                                            <span class="flex items-center gap-1 text-error font-semibold">
                                                                {% lucide_cached 'circle-x' size=14 %}
                                                                No
                                                            </span>
                                                        {% endif %}
                                                    {% else %}
                                                        {{ value_data.display_value }}
                                                    {% endif %}
                                                </div>
                                                {% endfor %}
                                            </div>
                                        {% else %}
                                            {# Single value - display inline #}
                                            <span class="text-xs">
                                                {% with value_data=group.values.0 %}
                                                    {% if group.attribute.attribute_type == 'URL' %}
                                                        <a href="{{ value_data.value }}" target="_blank" class="link link-hover text-primary">
                                                            {{ value_data.value }}
                                                        </a>
                                                    {% elif group.attribute.attribute_type == 'BOOLEAN' %}
                                                        {% if value_data.value %}
                                                            <span class="flex items-center gap-1 text-success font-semibold">
                                                                {% lucide_cached 'circle-check' size=14 %}
                                                                Yes
                                                            </span>
                                                        {% else %}
                                                            <span class="flex items-center gap-1 text-error font-semibold">
                                                                {% lucide_cached 'circle-x' size=14 %}
                                                                No
                                                            </span>
                                                        {% endif %}
                                                    {% else %}
                                                        {{ value_data.display_value }}
                                                    {% endif %}
                                                {% endwith %}
                                            </span>
                                        {% endif %}
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                    {% endif %}
                {% endwith %}
            {% endif %}
            
            {# Row 5: Links display (detailed like private view) #}
            {% if item.links.all %}
                <div class="mt-3">
                    <div class="flex flex-wrap gap-1 max-w-2xl">
                        {% for link in item.links.all %}
                        <div class="inline-flex items-center gap-1 mr-2 mb-1">
                            <a href="{{ link.url }}" target="_blank" class="text-xs flex items-center gap-1 hover:text-primary" title="{{ link.get_display_name }}: {{ link.url }}">
                                {{ link.get_display_name }}
                                {% lucide_cached link.get_icon size=10 %}
                            </a>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            {% endif %}
            
            {% comment %}
            Task 65: Row 6: Thumbnail images - removed eager loading for performance
            Thumbnails were causing 98ms template rendering time per item.
            Users can see images in the lightbox by clicking the main image.

            Commented out for performance - can be re-enabled if needed with lazy loading
            {% if item.images.all|length > 0 %}
            <div class="mt-3">
                <div class="flex flex-wrap gap-1 justify-start">
                    {% for image in item.images.all %}
                    <div class="avatar cursor-pointer hover:opacity-75 transition-opacity" onclick="showImageModal('{% media_url image.media_file %}', '{{ item.name|escapejs }} - Image {{ forloop.counter }}')">
                        <div class="w-12 h-12 rounded">
                            <img src="{% media_url image.media_file %}" alt="{{ item.name }} - Image {{ forloop.counter }}" class="object-cover" />
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}
            {% endcomment %}
            
        </div>
        
        {# Bottom section - Action buttons #}
        <div class="flex justify-end mt-4">
            {% if item.is_bookable %}
                {% if request.user.is_authenticated %}
                    {# Authenticated user: Simple POST to book #}
                    <button class="btn btn-sm btn-primary"
                            hx-post="{% url 'book_item_authenticated' item.hash %}"
                            hx-target="#item-{{ item.hash }}-container"
                            hx-swap="innerHTML"
                            hx-headers='{"X-CSRFToken": "{{ csrf_token }}"}'>
                        {% lucide_cached 'bookmark' size=14 class='mr-1' %}
                        Reserve
                    </button>
                {% else %}
                    {# Unauthenticated user: Dropdown with an inline form #}
                    <div class="dropdown dropdown-end">
                        <button tabindex="0" class="btn btn-sm btn-primary">
                            {% lucide_cached 'bookmark' size=14 class='mr-1' %}
                            Reserve
                        </button>
                        <div tabindex="0" class="dropdown-content z-10 card card-compact w-64 p-2 shadow bg-base-200 text-base-content">
                            <form hx-post="{% url 'book_item_guest' item.hash %}"
                                  hx-target="#item-{{ item.hash }}-container"
                                  hx-swap="innerHTML"
                                  hx-headers='{"X-CSRFToken": "{{ csrf_token }}"}'  
                                  class="card-body p-2">
                                <p class="text-sm font-semibold mb-1">Reserve as guest:</p>
                                <div class="form-control">
                                    <input type="email" name="email" placeholder="your.email@example.com" class="input input-bordered input-sm" required>
                                </div>
                                <p class="text-xs text-neutral mt-1">We'll send you a confirmation email with a cancellation link.</p>
                                <button type="submit" class="btn btn-success btn-sm mt-2">
                                    {% lucide_cached 'check' size=14 class='mr-1' %}
                                    Confirm
                                </button>
                            </form>
                        </div>
                    </div>
                {% endif %}
            {% endif %}
        </div>
        
    </div>
</div>