{% load i18n %}
{% load lucide %}

{# Give the card a unique ID so HTMX can target it #}
<div id="collection-row-{{ collection.hash }}" class="card lg:card-side bg-base-100 lg:min-h-48 min-w-80 max-w-md lg:min-w-96 lg:max-w-none mx-auto lg:mx-0">
    
    {# Image section using DaisyUI figure #}
    <figure class="lg:w-1/4 w-full h-48 lg:h-auto lg:self-stretch">
        {% if collection.default_image %}
            <img src="{{ collection.default_image.media_file.file_url }}" alt="{{ collection.name }}" class="w-full h-full object-cover" />
        {% elif collection.images.all.0 %}
            <img src="{{ collection.images.all.0.media_file.file_url }}" alt="{{ collection.name }}" class="w-full h-full object-cover" />
        {% else %}
            <div class="w-full h-full bg-base-300 flex items-center justify-center">
                {% lucide 'image' size=48 class='text-neutral' %}
            </div>
        {% endif %}
    </figure>
    
    {# Content section using DaisyUI card-body #}
    <div class="card-body lg:w-3/4 flex flex-col justify-between">
            
            {# Top section #}
            <div class="space-y-3">
                
                {# Row 1: Collection name (left) + Actions (right) #}
                <div class="flex flex-wrap lg:flex-nowrap items-center justify-between gap-4">
                    {# Collection name - wrapped if too long #}
                    <div class="flex-grow">
                        <h2 class="font-bold text-lg leading-tight">
                            <a href="{% url 'collection_detail' collection.hash %}" class="link link-hover break-words">{{ collection.name }}</a>
                        </h2>
                    </div>
                    
                    {# Action buttons with visibility badge #}
                    <div class="flex items-center gap-2 flex-shrink-0">
                        {# Visibility badge and main actions group using join #}
                        <div class="join">
                            {# Visibility Status Badge #}
                            <div class="badge gap-1 join-item h-8 {% if collection.visibility == 'PUBLIC' %}badge-accent{% elif collection.visibility == 'UNLISTED' %}badge-info{% else %}badge-neutral{% endif %}">
                                {% if collection.visibility == 'PUBLIC' %}{% lucide 'globe' size=12 %}{% elif collection.visibility == 'UNLISTED' %}{% lucide 'link' size=12 %}{% else %}{% lucide 'lock' size=12 %}{% endif %}
                                {{ collection.get_visibility_display }}
                            </div>
                            
                            {# Edit button #}
                            <a href="{% url "collection_update" collection.hash %}" class="btn btn-ghost btn-square btn-sm join-item" title="Edit Collection">
                                {% lucide 'pencil' size=18 %}
                            </a>
                            
                            {# Visibility Change Dropdown #}
                            <div class="dropdown dropdown-end dropdown-bottom join-item">
                                <button tabindex="0" class="btn btn-ghost btn-square btn-sm join-item" title="Change Visibility">
                                    {% lucide 'share-2' size=18 %}
                                </button>
                                <ul tabindex="0" class="dropdown-content menu p-2 shadow bg-base-100 rounded-box w-72 z-10">
                                    <li class="menu-title"><span>Change Visibility</span></li>
                                    {% for visibility_value, visibility_label in collection.Visibility.choices %}
                                    <li>
                                        {% if collection.visibility == visibility_value %}
                                            <a class="disabled font-bold">{{ visibility_label }}</a>
                                        {% else %}
                                            <a  hx-post="{% url 'collection_update_visibility' collection.hash %}"
                                                hx-vals='{"new_visibility": "{{ visibility_value }}"}'
                                                hx-target="#collection-row-{{ collection.hash }}"
                                                hx-swap="outerHTML"
                                                hx-headers='{"X-CSRFToken": "{{ csrf_token }}"}'>
                                                {{ visibility_label }}
                                            </a>
                                        {% endif %}
                                    </li>
                                    {% endfor %}
                                    {% if collection.visibility != 'PRIVATE' %}
                                        <div class="divider my-1"></div>
                                        <div class="form-control p-2">
                                            <div class="join">
                                                <input id="share-link-actions-{{ collection.hash }}" type="text" value="{{ collection.get_sharable_url }}" readonly class="input input-bordered input-sm w-full join-item text-xs" />
                                                <button class="btn btn-sm join-item" onclick="copyToClipboard('share-link-actions-{{ collection.hash }}', this)">{% lucide 'copy' size=16 %}</button>
                                                <a href="{{ collection.get_sharable_link }}" target="_blank" class="btn btn-sm join-item">{% lucide 'external-link' size=16 %}</a>
                                            </div>
                                        </div>
                                    {% endif %}
                                </ul>
                            </div>
                        </div>
                        
                        {# Separate Delete action group #}
                        {% include "partials/_collection_delete_dropdown.html" with collection=collection %}
                    </div>
                </div>
                
                {# Row 2: Share link (if not private) #}
                {% if collection.visibility != 'PRIVATE' %}
                <div class="join">
                    <input id="quick-share-{{ collection.hash }}" type="text" value="{{ collection.get_sharable_url }}" readonly class="input input-xs input-bordered join-item text-xs flex-grow" />
                    <button class="btn btn-xs join-item" onclick="copyToClipboard('quick-share-{{ collection.hash }}', this)" title="Copy share link">
                        {% lucide 'copy' size=12 %}
                    </button>
                    <a href="{{ collection.get_sharable_url }}" target="_blank" class="btn btn-xs join-item" title="Open in new tab">
                        {% lucide 'external-link' size=12 %}
                    </a>
                </div>
                {% endif %}
                
                {# Row 3: Description #}
                <p class="text-sm text-base-content text-neutral">{{ collection.description|default:"*The description appears to have wandered off somewhere, probably to have a cup of tea*"|truncatechars:200 }}</p>
                
            </div>
            
            {# Bottom section: Items count and updated time #}
            <div class="text-xs text-neutral">
                {{ collection.item_count }} item{{ collection.item_count|pluralize }} â€¢ Updated {{ collection.updated|timesince }} ago
            </div>
            
        </div>
        
</div>