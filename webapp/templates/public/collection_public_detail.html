{% extends "base_public.html" %}
{% load i18n %}
{% load lucide %}
{% load markdown_tags %}
{% load media_tags %}

{% block title %}{{ collection.name }}{% endblock %}

{% block breadcrumbs %}
    <li>
        <span class="inline-flex gap-2 items-center">
            {% lucide 'package' size=16 %}
            {{ collection.name }}
        </span>
    </li>
{% endblock breadcrumbs %}

{% block content %}
<div class="container mx-auto">

    {# Collection Hero Card - Updated to match private view #}
    <div class="{% if background_image_url %}bg-white/50 backdrop-blur-lg shadow-sm{% else %}bg-base-100 rounded-lg{% endif %} min-w-80 max-w-none mx-auto lg:mx-0 mb-8">

        {# Task 62: Header image removed - now using background image instead #}

        {# Content section using DaisyUI card-body #}
        <div class="card-body flex flex-col justify-between py-8 px-4">

            {# Top section #}
            <div class="space-y-4">

                <h1 class="text-5xl font-bold leading-tight text-gray-900">{{ collection.name }}</h1>

                <div class="flex items-center gap-2">
                    {% lucide 'user' size=16 class='text-gray-800' %}
                    <p class="text-lg text-gray-800">
                        Owned by {{ collection.created_by.profile.get_display_name }}
                    </p>
                </div>

                {# Only show description if it exists and is not empty #}
                {% if collection.description %}
                <p class="text-gray-900">{{ collection.description|markdown_safe }}</p>
                {% endif %}

                {# Collection Images Gallery - Show if there are multiple images or single image when no header #}
                {% if collection.images.all|length > 1 %}
                <div class="mt-6">
                    <h3 class="text-sm font-semibold mb-3 text-gray-800">Collection Images</h3>
                    <div class="grid grid-cols-4 sm:grid-cols-6 lg:grid-cols-8 gap-2">
                        {% for image in collection.images.all %}
                        <div class="aspect-square bg-base-200 rounded-md overflow-hidden cursor-pointer hover:opacity-90 transition-opacity" 
                             onclick="showImageModal('{% media_url image.media_file %}', '{{ collection.name|escapejs }} - Image {{ forloop.counter }}')">
                            <img src="{% media_url image.media_file %}" 
                                 alt="{{ collection.name }} - Image {{ forloop.counter }}" 
                                 class="w-full h-full object-cover" />
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}
                
            </div>
            
            {# Bottom section - Stats #}
            <div class="mt-4 flex justify-center">
                <div class="public-collection-stats stats stats-vertical sm:stats-horizontal shadow-none border-0 bg-transparent rounded-none">
                    <div class="stat rounded-none">
                        <div class="stat-title text-gray-900">Total Items</div>
                        <div class="stat-value">{{ stats.total_items }}</div>
                    </div>
                    <div class="stat rounded-none">
                        <div class="stat-title text-gray-900">In Collection</div>
                        <div class="stat-value text-success">{{ stats.in_collection_count }}</div>
                    </div>
                    <div class="stat rounded-none">
                        <div class="stat-title text-gray-900">Wanted</div>
                        <div class="stat-value text-info">{{ stats.wanted_count }}</div>
                    </div>
                    <div class="stat rounded-none">
                        <div class="stat-title text-gray-900">Reserved</div>
                        <div class="stat-value text-warning">{{ stats.reserved_count }}</div>
                    </div>
                </div>
            </div>
            
        </div>
        
    </div>

    {# Items listing #}
    <div class="{% if background_image_url %}bg-white/50 backdrop-blur-lg shadow-sm{% else %}bg-base-100{% endif %} px-4 py-4 mt-8">
        <h2 class="text-2xl font-bold mb-4 text-gray-900">Items in this Collection</h2>

        {% if stats.total_items > 0 %}
            <div class="flex flex-col gap-6">
                {# Task 47: Show grouped or ungrouped items based on collection setting #}
                {% if grouped_items %}
                    {# Display items grouped by attribute values #}
                    {% for group in grouped_items %}
                        {# Group header #}
                        <h3 class="text-lg font-semibold flex items-center gap-2 mt-2">
                            {% lucide 'layers' size=20 %}
                            {{ group.attribute_name }}{% if group.attribute_value %}: {{ group.attribute_value }}{% endif %}
                            <span class="badge badge-neutral badge-sm ml-2">{{ group.items|length }} items</span>
                        </h3>

                        {# Group items #}
                        {% for item in group.items %}
                            <div id="item-{{ item.hash }}-container">
                                {% include "partials/_item_public_card.html" with item=item %}
                            </div>
                        {% endfor %}
                    {% endfor %}
                {% else %}
                    {# Regular ungrouped display #}
                    {% for item in items %}
                        <div id="item-{{ item.hash }}-container">
                            {% include "partials/_item_public_card.html" with item=item %}
                        </div>
                    {% endfor %}
                {% endif %}
            </div>
            
            {# Pagination controls #}
            {% if page_obj and page_obj.has_other_pages %}
            <div class="flex flex-col md:flex-row items-center justify-between mt-8 gap-4">
                {# Page navigation #}
                <div class="join">
                    {% if page_obj.has_previous %}
                    <a href="?page=1&per_page={{ items_per_page }}" class="join-item btn btn-sm bg-base-100">«</a>
                    <a href="?page={{ page_obj.previous_page_number }}&per_page={{ items_per_page }}" class="join-item btn btn-sm bg-base-100">‹</a>
                    {% endif %}

                    <button class="join-item btn btn-sm bg-base-100 cursor-default">Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}</button>

                    {% if page_obj.has_next %}
                    <a href="?page={{ page_obj.next_page_number }}&per_page={{ items_per_page }}" class="join-item btn btn-sm bg-base-100">›</a>
                    <a href="?page={{ page_obj.paginator.num_pages }}&per_page={{ items_per_page }}" class="join-item btn btn-sm bg-base-100">»</a>
                    {% endif %}
                </div>

                {# Items per page selector #}
                <div class="form-control">
                    <select onchange="window.location.href='?page=1&per_page=' + this.value" class="select select-bordered select-sm bg-base-100">
                        <option value="10" {% if items_per_page == 10 %}selected{% endif %}>10 per page</option>
                        <option value="25" {% if items_per_page == 25 %}selected{% endif %}>25 per page</option>
                        <option value="50" {% if items_per_page == 50 %}selected{% endif %}>50 per page</option>
                        <option value="100" {% if items_per_page == 100 %}selected{% endif %}>100 per page</option>
                    </select>
                </div>
            </div>
            {% endif %}
        {% else %}
            <div class="card bg-base-100 shadow-sm p-8 text-center">
                {% lucide 'package-x' size=48 class='mx-auto text-neutral mb-4' %}
                <p class="text-lg text-neutral">This collection is currently empty.</p>
                <p class="text-sm opacity-60 mt-2">Check back later for new items!</p>
            </div>
        {% endif %}
    </div>
    {# End items list #}

</div>

{# Image lightbox modal #}
<dialog id="image-modal" class="modal backdrop-blur-sm">
    <div class="fixed inset-0 bg-black bg-opacity-90 flex items-center justify-center p-4">
        {# Close button - top right #}
        <button class="absolute top-4 right-4 z-10 btn btn-circle btn-ghost text-white hover:bg-base-100 hover:bg-opacity-20" 
                onclick="document.getElementById('image-modal').close()" 
                title="Close (ESC)">
            {% lucide 'x' size=24 %}
        </button>
        
        {# Image title - top center #}
        <div class="absolute top-4 left-1/2 transform -translate-x-1/2 z-10 text-white text-lg font-medium text-center px-4 py-2 bg-black bg-opacity-50 rounded-lg" id="image-modal-title">
            Image Preview
        </div>
        
        {# Main image - centered #}
        <img id="image-modal-img" 
             src="" 
             alt="" 
             class="max-w-full max-h-full object-contain shadow-2xl" />
    </div>
    
    {# Backdrop click to close #}
    <form method="dialog" class="modal-backdrop">
        <button>close</button>
    </form>
</dialog>

<script>
function showImageModal(imageUrl, imageTitle) {
    const modal = document.getElementById('image-modal');
    const img = document.getElementById('image-modal-img');
    const title = document.getElementById('image-modal-title');
    
    img.src = imageUrl;
    img.alt = imageTitle;
    title.textContent = imageTitle;
    
    modal.showModal();
    
    // Add keyboard event listener for ESC key
    const handleKeydown = (e) => {
        if (e.key === 'Escape') {
            modal.close();
        }
    };
    document.addEventListener('keydown', handleKeydown);
    
    // Remove event listener when modal closes
    modal.addEventListener('close', () => {
        document.removeEventListener('keydown', handleKeydown);
    }, { once: true });
}
</script>

{% endblock %}