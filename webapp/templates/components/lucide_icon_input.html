{% load lucide %}
{% comment %}
Simplified Lucide Icon Input Component

Usage:
{% include 'components/lucide_icon_input.html' with field_name='icon' field_value=item_type.icon field_id='icon_input' %}

Parameters:
- field_name: Name attribute for the input (required)
- field_value: Current value of the field (optional)
- field_id: ID for the input element (optional, defaults to field_name)
- placeholder: Placeholder text (optional)
- required: Whether field is required (optional)
{% endcomment %}

<div class="form-control w-full">
    <label class="label">
        <span class="label-text">Lucide Icon Name {% if required %}<span class="text-error">*</span>{% endif %}</span>
    </label>
    
    <div class="relative">
        <!-- Main input field -->
        <input 
            type="text" 
            name="{{ field_name }}" 
            id="{{ field_id|default:field_name }}"
            class="input input-bordered w-full pr-10" 
            placeholder="{{ placeholder|default:'e.g., book, user, settings' }}"
            value="{{ field_value|default:'' }}"
            autocomplete="off"
            {% if required %}required{% endif %}
        >
        
        <!-- Icon preview (shows when valid icon is entered) -->
        <div class="absolute inset-y-0 right-0 flex items-center pr-3">
            <div id="{{ field_id|default:field_name }}_preview" class="text-blue-500">
                {% if field_value %}
                    {% lucide field_value size=16 %}
                {% endif %}
            </div>
        </div>
    </div>
    
    <!-- Validation feedback area -->
    <div id="{{ field_id|default:field_name }}_validation" class="mt-2">
        <!-- Client-side validation feedback will appear here -->
    </div>
    
    <label class="label">
        <span class="label-text-alt">
            <a href="https://lucide.dev/icons/" target="_blank" class="link terminal-accent">Browse available icons</a>
            â€¢ Enter icon name manually
        </span>
    </label>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const input = document.getElementById('{{ field_id|default:field_name }}');
    const previewDiv = document.getElementById('{{ field_id|default:field_name }}_preview');
    const validationDiv = document.getElementById('{{ field_id|default:field_name }}_validation');
    
    let validationTimeout;
    
    // Common Lucide icons for suggestions
    const commonIcons = [
        'book', 'user', 'settings', 'house', 'star', 'heart', 'plus', 'minus', 'pencil', 'trash',
        'search', 'filter', 'download', 'upload', 'share', 'link', 'tag', 'folder', 'file',
        'image', 'video', 'music', 'mail', 'phone', 'message-circle', 'bell', 'clock',
        'calendar', 'map-pin', 'camera', 'mic', 'volume-2', 'wifi', 'battery', 'bluetooth'
    ];
    
    // Handle input validation
    input.addEventListener('input', function() {
        const iconName = this.value.trim();
        
        clearTimeout(validationTimeout);
        
        if (iconName) {
            validationTimeout = setTimeout(() => {
                validateIcon(iconName);
            }, 300);
        } else {
            clearValidation();
        }
    });
    
    function validateIcon(iconName) {
        // Try to create the icon element to test if it exists
        const testElement = document.createElement('i');
        testElement.setAttribute('data-lucide', iconName);
        testElement.style.display = 'none';
        document.body.appendChild(testElement);
        
        // Attempt to initialize the icon
        if (typeof lucide !== 'undefined') {
            lucide.createIcons();
            
            // Check if icon was successfully created
            setTimeout(() => {
                const hasIcon = testElement.querySelector('svg') !== null;
                document.body.removeChild(testElement);
                
                if (hasIcon) {
                    showValidIcon(iconName);
                } else {
                    showInvalidIcon(iconName);
                }
            }, 100);
        } else {
            // Fallback: just show preview without validation
            updateIconPreview(iconName);
            document.body.removeChild(testElement);
        }
    }
    
    function showValidIcon(iconName) {
        input.classList.remove('input-error');
        input.classList.add('input-success');
        
        validationDiv.innerHTML = `
            <div class="text-success text-sm flex items-center gap-1">
                {% lucide 'circle-check' size=16 %}
                <span>Valid icon name</span>
            </div>
        `;
        
        updateIconPreview(iconName);
        
        // Re-initialize Lucide icons
        if (typeof lucide !== 'undefined') {
            lucide.createIcons();
        }
    }
    
    function showInvalidIcon(iconName) {
        input.classList.remove('input-success');
        input.classList.add('input-error');
        
        // Find suggestions
        const suggestions = commonIcons.filter(icon => 
            icon.includes(iconName.toLowerCase()) || 
            iconName.toLowerCase().includes(icon)
        ).slice(0, 5);
        
        let html = `
            <div class="text-error text-sm flex items-center gap-1 mb-2">
                {% lucide 'circle-alert' size=16 %}
                <span>Icon '${iconName}' not found</span>
            </div>
        `;
        
        if (suggestions.length > 0) {
            html += `
                <div class="text-sm">
                    <span class="text-base-content">Suggestions: </span>
                    ${suggestions.map(icon => `
                        <button type="button" 
                                class="btn btn-xs btn-outline mr-1 mb-1 suggestion-btn"
                                data-icon="${icon}">
                            ${icon}
                        </button>
                    `).join('')}
                </div>
            `;
        }
        
        validationDiv.innerHTML = html;
        previewDiv.innerHTML = '';
        
        // Add click handlers to suggestion buttons
        validationDiv.querySelectorAll('.suggestion-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const suggestedIcon = this.dataset.icon;
                input.value = suggestedIcon;
                input.dispatchEvent(new Event('input'));
            });
        });
        
        // Re-initialize Lucide icons
        if (typeof lucide !== 'undefined') {
            lucide.createIcons();
        }
    }
    
    function clearValidation() {
        input.classList.remove('input-error', 'input-success');
        validationDiv.innerHTML = '';
        previewDiv.innerHTML = '';
    }
    
    function updateIconPreview(iconName) {
        if (iconName) {
            previewDiv.innerHTML = `<i data-lucide="${iconName}" class="w-4 h-4"></i>`;
            if (typeof lucide !== 'undefined') {
                lucide.createIcons();
            }
        } else {
            previewDiv.innerHTML = '';
        }
    }
    
    // Initialize preview if there's an initial value
    if (input.value.trim()) {
        validateIcon(input.value.trim());
    }
});
</script>