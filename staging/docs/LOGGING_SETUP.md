# Beryl3 Logging Setup Documentation

## Overview
This document describes the complete logging infrastructure for the Beryl3 application in the staging environment, including log flow from application to visualization.

## Architecture

### Log Flow
```
Beryl3 Django App → Loki → Grafana Dashboard
```

1. **Beryl3 Application** sends structured JSON logs to Loki via `python-logging-loki`
2. **Loki** aggregates and stores logs with labels
3. **Grafana** queries Loki to display logs in dashboards

## Configuration Details

### Django Application (Beryl3)
**Location:** `/opt/beryl3/.env` (generated by Ansible)

Key environment variables:
```env
LOKI_ENABLED=True
LOKI_URL=http://loki:3100
SENTRY_ENVIRONMENT=staging
```

**Log Labels Generated:**
- `application="beryl3"`
- `environment="staging"`
- `service_name="beryl3"`
- `logger` (django.server, webapp, performance, etc.)
- `severity` (info, warning, error)

### Loki Configuration
**Template:** `ansible/roles/shared-monitoring/templates/loki.yml.j2`
**Container:** `loki` (port 3100)

### Grafana Configuration 
**Templates:**
- Datasources: `ansible/roles/shared-monitoring/templates/grafana-datasources.yml.j2`
- Dashboard config: `ansible/roles/shared-monitoring/templates/grafana-dashboards.yml.j2`

**Loki Datasource:**
```yaml
- name: loki
  type: loki
  uid: loki
  access: proxy
  url: http://loki:3100
```

## Dashboards

### Beryl3 Application Logs Dashboard
**File:** `ansible/custom-dashboards/beryl3-application-logs.json`
**URL:** `https://grafana.staging.mdubiel.org/d/ac8dadef-a6ff-4f1b-a437-7226d0efe446/beryl3-application-logs`

**Panels:**
1. **Log Count** - Total beryl3 logs in last hour
2. **Error Count** - Error-level logs in last hour  
3. **Log Rate by Logger** - Volume by logger type over time
4. **Errors and Warnings** - Error/warning rates over time
5. **Recent Error Logs** - Table of recent errors
6. **All Recent Logs** - Table of all recent beryl3 logs

**Key Queries:**
- Total logs: `sum(count_over_time({service_name="beryl3"}[1h]))`
- Errors: `sum(count_over_time({service_name="beryl3", severity="error"}[1h]))`
- By logger: `sum by (logger) (rate({service_name="beryl3"}[5m]))`

## Management Commands

### Deploy/Update Configuration
```bash
# Update Grafana datasources
ansible-playbook -i ansible/inventory/staging.yml ansible/playbooks/grafana-management.yml --tags datasources

# Deploy custom dashboards (including beryl3)
ansible-playbook -i ansible/inventory/staging.yml ansible/playbooks/grafana-management.yml --tags custom-dashboards

# Full Grafana management
ansible-playbook -i ansible/inventory/staging.yml ansible/playbooks/grafana-management.yml
```

### Verify Configuration
```bash
# Check Loki labels
curl -s 'http://localhost:3100/loki/api/v1/labels'

# Check beryl3 logs
curl -s 'http://localhost:3100/loki/api/v1/label/service_name/values'

# Check Grafana datasources
curl -s -u admin:admin123 'http://localhost:3000/api/datasources'
```

## Accessing Logs

### Direct Loki Queries
```bash
# Recent beryl3 logs
curl -s -G 'http://localhost:3100/loki/api/v1/query_range' \
  --data-urlencode 'query={service_name="beryl3"}' \
  --data-urlencode 'limit=10'

# Beryl3 errors only
curl -s -G 'http://localhost:3100/loki/api/v1/query_range' \
  --data-urlencode 'query={service_name="beryl3", severity="error"}' \
  --data-urlencode 'limit=10'
```

### Grafana Access
- **URL:** https://grafana.staging.mdubiel.org
- **Credentials:** admin / admin123
- **Beryl3 Dashboard:** Navigate to "Beryl3 Application Logs"

## Troubleshooting

### No Logs Appearing
1. Check beryl3 container environment variables
2. Verify Loki container is running and accessible
3. Test direct Loki API queries

### Dashboard Not Working
1. Verify Loki datasource configuration in Grafana
2. Check dashboard queries use correct labels (`service_name="beryl3"`)
3. Ensure Grafana can reach Loki container

### Configuration Not Persistent
1. Ensure templates are in place:
   - `ansible/roles/shared-monitoring/templates/grafana-datasources.yml.j2`
   - `ansible/roles/shared-monitoring/templates/grafana-dashboards.yml.j2`
2. Deploy configuration via ansible:
   ```bash
   ansible-playbook -i ansible/inventory/staging.yml ansible/playbooks/grafana-management.yml
   ```

## Files Reference

### Templates
- `ansible/roles/shared-monitoring/templates/loki.yml.j2`
- `ansible/roles/shared-monitoring/templates/grafana-datasources.yml.j2`  
- `ansible/roles/shared-monitoring/templates/grafana-dashboards.yml.j2`
- `ansible/playbooks/templates/beryl3.env.j2`

### Custom Dashboards
- `ansible/custom-dashboards/beryl3-application-logs.json`

### Playbooks
- `ansible/playbooks/grafana-management.yml` - Grafana configuration management
- `ansible/playbooks/deploy-app.yml` - Beryl3 application deployment

## Status
✅ Beryl3 logs flowing to Loki
✅ Loki datasource configured in Grafana  
✅ Beryl3 Application Logs dashboard created
✅ All configuration persistent via Ansible templates

**Last Updated:** 2025-09-12
**Environment:** Staging
**Beryl3 Version:** Latest from registry